<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GSR Stress Monitor - Local UI</title>
  <style>
    :root {
      --primary: #3b82f6;
      --secondary: #10b981;
      --surface: #f3f4f6;
      --background: #ffffff;
      --text: #1f2937;
      --subtext: #6b7280;
    }
    body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background-color: var(--background); color: var(--text); margin:0; padding:20px; display:flex; justify-content:center; }
    .container { width:100%; max-width:1200px; }
    header { text-align:center; margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid var(--surface); }
    header h1{ color:var(--primary); margin:0; font-weight:600 }
    .controls { display:flex; justify-content:center; gap:20px; margin-bottom:30px }
    .button { padding:10px 20px; border:none; border-radius:8px; font-size:16px; cursor:pointer; font-weight:500 }
    #startButton{ background:var(--secondary); color:#fff }
    #stopButton{ background:#ef4444; color:#fff }
    .card{ background:var(--surface); padding:20px; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.05); text-align:center }
    .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(250px,1fr)); gap:20px; margin-bottom:30px }
    .chart-container{ background:var(--surface); padding:20px; border-radius:12px; height:400px }
    /* Camera box */
    .cam-box{ position:fixed; top:20px; left:20px; width:220px; height:160px; background:#ffffffcc; border-radius:10px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,0.12); z-index:1200; display:flex; align-items:center; justify-content:center; flex-direction:column }
    .cam-box video{ width:100%; height:100%; object-fit:cover }
    .cam-overlay{ position:absolute; left:6px; top:6px; right:6px; display:flex; justify-content:space-between; align-items:center; gap:6px }
    #camStatus{ font-size:12px; color:#0f172a; background:#ffffffcc; padding:4px 8px; border-radius:6px }
    #enableCamBtn{ padding:6px 8px; font-size:12px; border-radius:6px; border:none; background:#3b82f6; color:#fff; cursor:pointer }
  </style>
</head>
<body>
  <div class="container">
    <div id="camBox" class="cam-box" aria-live="polite">
      <video id="localVideo" autoplay playsinline muted></video>
      <div id="camOverlay" class="cam-overlay">
        <div id="camStatus">Camera: inactive — click Enable</div>
        <button id="enableCamBtn">Enable Camera</button>
      </div>
    </div>

    <header>
      <h1>GSR Stress Monitor</h1>
      <p>Real-time Galvanic Skin Response (GSR) Monitoring</p>
    </header>

    <div class="controls">
      <button id="startButton" class="button">Start Session</button>
      <button id="stopButton" class="button" disabled>Stop & Download CSV</button>
    </div>

    <div class="stage-info">
      <div class="stage-header">
        <h2>Stage: <span id="stageDescription">Waiting to start...</span></h2>
        <div class="stage-timer-display">Remaining: <span id="stageTimer">--:--</span></div>
      </div>
      <div class="progress-bar-container"><div id="stageProgress" style="height:8px;width:0;background:var(--primary)"></div></div>
    </div>

    <div class="stats-grid">
      <div class="card">
        <div class="card-title">Resistance Value</div>
        <div class="card-value" id="resistanceValue">0.00 Ω</div>
      </div>
      <div class="card">
        <div class="card-title">Session Elapsed Time</div>
        <div class="card-value" id="sessionTimer">00:00</div>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="chart" style="width:100%;height:100%"></canvas>
    </div>
  </div>

  <script>
    // Change these to your ESP IP (device AP)
    const ESP_BASE = 'http://192.168.4.1';

    // Lightweight chart (same as firmware page)
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    const chart = { data:{datasets:[{data:[]}]} };
    function resizeCanvas(){ const rect=canvas.getBoundingClientRect(); canvas.width=Math.floor(rect.width); canvas.height=Math.floor(rect.height); }
    function drawGrid(){ const padding=40; const w=canvas.width-padding*2; const h=canvas.height-padding*2; ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--surface')||'#f3f4f6'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1; const lines=5; for(let i=0;i<=lines;i++){ const y=padding+(i/lines)*h; ctx.beginPath(); ctx.moveTo(padding,y); ctx.lineTo(padding+w,y); ctx.stroke(); } ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--text')||'#1f2937'; ctx.font='12px sans-serif'; ctx.save(); ctx.translate(12,canvas.height/2); ctx.rotate(-Math.PI/2); ctx.fillText('Resistance (Ω)',0,0); ctx.restore(); }
    function drawChart(){ resizeCanvas(); ctx.clearRect(0,0,canvas.width,canvas.height); const data=chart.data.datasets[0].data; if(!data||data.length===0){ drawGrid(); return;} const padding=40; const w=canvas.width-padding*2; const h=canvas.height-padding*2; const max=Math.max(...data); const min=Math.min(...data); const range=(max-min)||1; drawGrid(); ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--primary')||'#3b82f6'; for(let i=0;i<data.length;i++){ const x=padding+(i/Math.max(1,data.length-1))*w; const y=padding+h-((data[i]-min)/range)*h; if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);} ctx.stroke(); }

    let dataLog=[]; let sessionActive=false; let intervalId=null; let autoDownloadExecuted=false;

    function downloadCSV(){ if(dataLog.length===0){ console.log('No data to download.'); return;} const csv=dataLog.reduce((acc,row)=> acc+=`${row.elapsed},${row.value},${row.stage}\n`, 'Time (s),Resistance (Ω),Stage\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='GSR_Data.csv'; a.click(); URL.revokeObjectURL(url); }

    document.getElementById('startButton').onclick = () => {
      dataLog=[]; chart.data.datasets[0].data=[]; drawChart(); autoDownloadExecuted=false;
      // request camera as user gesture
      try{ if(typeof startCamera==='function'){ console.log('Requesting camera on Start click'); startCamera(); } } catch(e){ console.warn('startCamera failed',e); }
      fetch(ESP_BASE + '/start').then(()=>{ document.getElementById('startButton').disabled=true; document.getElementById('stopButton').disabled=false; sessionActive=true; if(!intervalId) intervalId=setInterval(fetchData,1000); }).catch(e=>console.error('Error starting session',e));
    };

    document.getElementById('stopButton').onclick = () => {
      fetch(ESP_BASE + '/stop').then(()=>{ document.getElementById('startButton').disabled=false; document.getElementById('stopButton').disabled=true; sessionActive=false; if(intervalId){ clearInterval(intervalId); intervalId=null;} downloadCSV(); }).catch(e=>console.error('Error stopping session',e));
    };

    function formatTime(seconds){ const mins=Math.floor(seconds/60); const secs=seconds%60; return `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`; }

    async function fetchData(){ if(!sessionActive){ if(!autoDownloadExecuted && dataLog.length>0){ document.getElementById('stageDescription').textContent='Session complete. Downloading data...'; downloadCSV(); autoDownloadExecuted=true; if(intervalId){ clearInterval(intervalId); intervalId=null;} } return; }
      try{ const resp=await fetch(ESP_BASE + '/resistance'); const data=await resp.json(); if(Object.keys(data).length===0 || data.finished){ document.getElementById('startButton').disabled=false; document.getElementById('stopButton').disabled=false; sessionActive=false; document.getElementById('stageDescription').textContent='Session complete. Ready for download (Auto-downloading...)'; if(!autoDownloadExecuted){ downloadCSV(); autoDownloadExecuted=true; } if(intervalId){ clearInterval(intervalId); intervalId=null;} return; }
        document.getElementById('stageTimer').textContent = formatTime(data.remaining);
        document.getElementById('stageDescription').textContent = data.description;
        document.getElementById('sessionTimer').textContent = formatTime(data.elapsed);
        let resistanceDisplay = data.value > 100000000 ? (data.value/1000000).toFixed(2) + ' MΩ' : data.value.toFixed(2) + ' Ω';
        document.getElementById('resistanceValue').textContent = resistanceDisplay;
        const progress = (1 - (data.remaining / data.stageDuration)) * 100;
        document.getElementById('stageProgress').style.width = `${progress}%`;
        if(chart.data.datasets[0].data.length >= 600) chart.data.datasets[0].data.shift();
        chart.data.datasets[0].data.push(data.value);
        drawChart();
        dataLog.push({ elapsed: data.elapsed, value: data.value, stage: data.stage });
      } catch(err){ console.error('Error fetching data:', err); }
    }

    // Camera handling
    const videoEl = document.getElementById('localVideo');
    const camStatus = document.getElementById('camStatus');
    const enableBtn = document.getElementById('enableCamBtn');

    function isSafari(){ return /^((?!chrome|android).)*safari/i.test(navigator.userAgent); }

    async function startCamera(){ if(!navigator || !navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){ camStatus.textContent='Camera API not supported'; console.warn('getUserMedia not available'); return; }
      try{ camStatus.textContent='Camera: requesting...'; const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false }); videoEl.srcObject = stream; camStatus.textContent='Camera: active'; enableBtn.style.display='none'; console.log('Camera stream started'); } catch(err){ console.error('Camera start failed:', err); if(isSafari()){ camStatus.textContent='Camera blocked by Safari (requires HTTPS). Try Chrome or enable manually.'; } else { camStatus.textContent='Camera blocked/unavailable — click Enable to retry'; } enableBtn.style.display='inline-block'; }
    }

    enableBtn.onclick = () => { startCamera(); };

    window.addEventListener('load', () => { if(!navigator || !navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){ camStatus.textContent='Camera API not supported'; enableBtn.style.display='none'; } else { enableBtn.style.display='inline-block'; if(isSafari()){ camStatus.textContent='Safari may require HTTPS; click Enable or use Chrome'; } else { camStatus.textContent='Click Enable to allow camera access'; } } });
  </script>
</body>
</html>
